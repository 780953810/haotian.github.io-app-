<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3B82F6">
    <meta name="mobile-web-app-capable" content="yes">
    <title>油品到站成本价计算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-active {
                @apply bg-blue-600 text-white;
            }
            .btn-inactive {
                @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
            }
            .page {
                @apply hidden;
            }
            .page.active {
                @apply block;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        info: '#3B82F6',
                        light: '#F3F4F6',
                        dark: '#1F2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-3 max-w-md">
        <!-- 主页面 -->
        <div id="main-page" class="page active">
            <header class="text-center my-4">
                <h1 class="text-2xl font-bold text-gray-800">油品到站成本价计算器</h1>
            </header>

            <main>
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <div class="mb-6">
                        <label for="factory-price" class="block text-gray-700 text-sm font-bold mb-2">出厂价</label>
                        <div class="relative">
                            <input type="number" id="factory-price" placeholder="请输入出厂价" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="absolute right-4 top-2 text-gray-500">元/吨</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button id="tax-gasoline" class="oil-type-btn btn-inactive py-2 px-3 rounded-lg text-sm font-semibold transition-colors duration-200 flex items-center justify-center">
                            <i data-lucide="droplets" class="mr-1 h-4 w-4"></i>
                            含税汽油
                        </button>
                        <button id="non-tax-gasoline" class="oil-type-btn btn-inactive py-2 px-3 rounded-lg text-sm font-semibold transition-colors duration-200 flex items-center justify-center">
                            <i data-lucide="droplets" class="mr-1 h-4 w-4"></i>
                            不含税汽油
                        </button>
                        <button id="tax-diesel" class="oil-type-btn btn-inactive py-2 px-3 rounded-lg text-sm font-semibold transition-colors duration-200 flex items-center justify-center">
                            <i data-lucide="fuel" class="mr-1 h-4 w-4"></i>
                            含税柴油
                        </button>
                        <button id="non-tax-diesel" class="oil-type-btn btn-inactive py-2 px-3 rounded-lg text-sm font-semibold transition-colors duration-200 flex items-center justify-center">
                            <i data-lucide="fuel" class="mr-1 h-4 w-4"></i>
                            不含税柴油
                        </button>
                    </div>

                    <div id="result-area" class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <div class="flex items-center">
                            <i data-lucide="calculator" class="text-blue-500 mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-500" id="result-type"></p>
                                <p class="text-2xl font-bold text-gray-800" id="result-price"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button id="trend-btn" class="bg-secondary text-white py-2 px-3 rounded-lg text-sm font-semibold transition-colors duration-200 flex items-center justify-center">
                        <i data-lucide="line-chart" class="mr-1 h-4 w-4"></i>
                        价格趋势曲线图
                    </button>
                    <button id="guidance-btn" class="bg-info text-white py-2 px-3 rounded-lg text-sm font-semibold transition-colors duration-200 flex items-center justify-center">
                        <i data-lucide="settings" class="mr-1 h-4 w-4"></i>
                        当前指导价
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                        <i data-lucide="history" class="mr-2 h-5 w-5"></i>
                        历史记录
                    </h2>
                    <div id="history-list" class="max-h-64 overflow-y-auto">
                        <!-- 历史记录将在这里动态生成 -->
                    </div>
                </div>
            </main>
        </div>

        <!-- 价格趋势曲线图页面 -->
        <div id="trend-page" class="page">
            <header class="flex justify-between items-center my-8">
                <h1 class="text-3xl font-bold text-gray-800">价格趋势曲线图</h1>
                <button id="back-from-trend" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded-lg font-semibold transition-colors duration-200 flex items-center">
                    <i data-lucide="arrow-left" class="mr-2"></i>
                    返回
                </button>
            </header>
            <main>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="mb-4">
                        <canvas id="trend-chart"></canvas>
                    </div>
                </div>
            </main>
        </div>

        <!-- 当前指导价页面 -->
        <div id="guidance-page" class="page">
            <header class="flex justify-between items-center my-8">
                <h1 class="text-3xl font-bold text-gray-800">当前指导价</h1>
                <button id="back-from-guidance" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded-lg font-semibold transition-colors duration-200 flex items-center">
                    <i data-lucide="arrow-left" class="mr-2"></i>
                    返回
                </button>
            </header>
            <main>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div id="guidance-0-diesel" class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">0号柴油价格</label>
                        <div class="flex items-center">
                            <input type="number" class="guidance-price w-full px-4 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入价格">
                            <span class="bg-gray-200 px-4 py-2 border-t border-r border-b rounded-r-lg text-gray-500">元/升</span>
                            <button class="save-guidance ml-2 bg-green-500 text-white py-2 px-4 rounded-lg font-semibold transition-colors duration-200">保存</button>
                            <button class="edit-guidance ml-2 bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold transition-colors duration-200 hidden">修改</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">最新保存时间：<span class="save-time"></span></p>
                    </div>
                    <div id="guidance-92-gasoline" class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">92号汽油价格</label>
                        <div class="flex items-center">
                            <input type="number" class="guidance-price w-full px-4 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入价格">
                            <span class="bg-gray-200 px-4 py-2 border-t border-r border-b rounded-r-lg text-gray-500">元/升</span>
                            <button class="save-guidance ml-2 bg-green-500 text-white py-2 px-4 rounded-lg font-semibold transition-colors duration-200">保存</button>
                            <button class="edit-guidance ml-2 bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold transition-colors duration-200 hidden">修改</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">最新保存时间：<span class="save-time"></span></p>
                    </div>
                    <div id="guidance-95-gasoline" class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">95号汽油价格</label>
                        <div class="flex items-center">
                            <input type="number" class="guidance-price w-full px-4 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入价格">
                            <span class="bg-gray-200 px-4 py-2 border-t border-r border-b rounded-r-lg text-gray-500">元/升</span>
                            <button class="save-guidance ml-2 bg-green-500 text-white py-2 px-4 rounded-lg font-semibold transition-colors duration-200">保存</button>
                            <button class="edit-guidance ml-2 bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold transition-colors duration-200 hidden">修改</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">最新保存时间：<span class="save-time"></span></p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const PAGES = {
                MAIN: 'main-page',
                TREND: 'trend-page',
                GUIDANCE: 'guidance-page'
            };

            const OIL_TYPES = {
                TAX_GASOLINE: { id: 'tax-gasoline', name: '含税汽油', formula: (price) => (price + 200) / 1350 },
                NON_TAX_GASOLINE: { id: 'non-tax-gasoline', name: '不含税汽油', formula: (price) => (price + 200) / 1350 },
                TAX_DIESEL: { id: 'tax-diesel', name: '含税柴油', formula: (price) => (price + 200) / 1200 },
                NON_TAX_DIESEL: { id: 'non-tax-diesel', name: '不含税柴油', formula: (price) => (price + 200) / 1200 }
            };

            let historyRecords = JSON.parse(localStorage.getItem('historyRecords')) || [];
            let guidancePrices = JSON.parse(localStorage.getItem('guidancePrices')) || {};
            let trendChart = null;

            const factoryPriceInput = document.getElementById('factory-price');
            const oilTypeBtns = document.querySelectorAll('.oil-type-btn');
            const resultArea = document.getElementById('result-area');
            const resultType = document.getElementById('result-type');
            const resultPrice = document.getElementById('result-price');
            const historyList = document.getElementById('history-list');
            const trendBtn = document.getElementById('trend-btn');
            const guidanceBtn = document.getElementById('guidance-btn');
            const backFromTrendBtn = document.getElementById('back-from-trend');
            const backFromGuidanceBtn = document.getElementById('back-from-guidance');

            function switchPage(pageId) {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(pageId).classList.add('active');

                if (pageId === PAGES.TREND) {
                    renderTrendChart();
                } else if (pageId === PAGES.GUIDANCE) {
                    renderGuidancePrices();
                }
            }

            function calculateCostPrice(oilType) {
                const factoryPrice = parseFloat(factoryPriceInput.value);
                if (isNaN(factoryPrice)) {
                    alert('请输入价格');
                    return;
                }

                const costPrice = oilType.formula(factoryPrice);
                resultType.textContent = `${oilType.name}到站成本价`;
                resultPrice.textContent = `${costPrice.toFixed(2)} 元/升`;
                resultArea.classList.remove('hidden');

                const record = {
                    id: Date.now(),
                    time: new Date().toLocaleString('zh-CN'),
                    type: oilType.name,
                    factoryPrice: factoryPrice,
                    costPrice: costPrice
                };

                historyRecords.unshift(record);
                if (historyRecords.length > 100) {
                    historyRecords.pop();
                }
                localStorage.setItem('historyRecords', JSON.stringify(historyRecords));
                renderHistoryList();
            }

            function renderHistoryList() {
                historyList.innerHTML = '';
                historyRecords.forEach(record => {
                    const recordElement = document.createElement('div');
                    recordElement.className = 'border-b last:border-b-0 pb-3 pt-3 flex justify-between items-center';
                    recordElement.innerHTML = `
                        <div>
                            <p class="text-sm text-gray-500">${record.time}</p>
                            <p class="font-semibold">${record.type}</p>
                            <p class="text-sm text-gray-600">出厂价: ${record.factoryPrice} 元/吨 | 成本价: ${record.costPrice.toFixed(2)} 元/升</p>
                        </div>
                        <button class="delete-record text-red-500 hover:text-red-700" data-id="${record.id}">
                            <i data-lucide="trash-2"></i>
                        </button>
                    `;
                    historyList.appendChild(recordElement);
                });
                lucide.createIcons();
                
                document.querySelectorAll('.delete-record').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const recordId = e.currentTarget.dataset.id;
                        if (confirm('确定要删除这条记录吗？')) {
                            historyRecords = historyRecords.filter(r => r.id != recordId);
                            localStorage.setItem('historyRecords', JSON.stringify(historyRecords));
                            renderHistoryList();
                        }
                    });
                });
            }

            function renderTrendChart() {
                const ctx = document.getElementById('trend-chart').getContext('2d');
                
                if (trendChart) {
                    trendChart.destroy();
                }

                const chartData = {};
                Object.values(OIL_TYPES).forEach(type => {
                    chartData[type.name] = [];
                });

                const dailyData = {};
                historyRecords.forEach(record => {
                    const date = record.time.split(' ')[0];
                    if (!dailyData[date]) {
                        dailyData[date] = {};
                        Object.values(OIL_TYPES).forEach(type => {
                            dailyData[date][type.name] = null;
                        });
                    }
                    dailyData[date][record.type] = record.costPrice;
                });

                const sortedDates = Object.keys(dailyData).sort();
                sortedDates.forEach(date => {
                    Object.values(OIL_TYPES).forEach(type => {
                        if (dailyData[date][type.name] !== null) {
                            chartData[type.name].push({
                                x: date,
                                y: dailyData[date][type.name]
                            });
                        }
                    });
                });

                const datasets = Object.entries(chartData).map(([type, data], index) => {
                    const colors = ['#3B82F6', '#10B981', '#EF4444', '#F59E0B'];
                    return {
                        label: type,
                        data: data,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    };
                });

                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'category',
                                title: {
                                    display: true,
                                    text: '日期'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '到站成本价 (元/升)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            },
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }

            function renderGuidancePrices() {
                Object.keys(guidancePrices).forEach(key => {
                    const item = document.getElementById(key);
                    if (item) {
                        const priceInput = item.querySelector('.guidance-price');
                        const saveBtn = item.querySelector('.save-guidance');
                        const editBtn = item.querySelector('.edit-guidance');
                        const saveTimeSpan = item.querySelector('.save-time');
                        
                        priceInput.value = guidancePrices[key].price;
                        priceInput.disabled = true;
                        saveBtn.classList.add('hidden');
                        editBtn.classList.remove('hidden');
                        saveTimeSpan.textContent = guidancePrices[key].time;
                    }
                });
            }

            oilTypeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const oilTypeId = btn.id;
                    const oilType = Object.values(OIL_TYPES).find(t => t.id === oilTypeId);
                    if (oilType) {
                        calculateCostPrice(oilType);
                    }
                });
            });

            trendBtn.addEventListener('click', () => switchPage(PAGES.TREND));
            guidanceBtn.addEventListener('click', () => switchPage(PAGES.GUIDANCE));
            backFromTrendBtn.addEventListener('click', () => switchPage(PAGES.MAIN));
            backFromGuidanceBtn.addEventListener('click', () => switchPage(PAGES.MAIN));

            document.querySelectorAll('.save-guidance').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const container = e.currentTarget.closest('[id^="guidance-"]');
                    const priceInput = container.querySelector('.guidance-price');
                    const price = parseFloat(priceInput.value);
                    if (isNaN(price)) {
                        alert('请输入有效的价格');
                        return;
                    }
                    const saveTime = new Date().toLocaleString('zh-CN');
                    guidancePrices[container.id] = { price, time: saveTime };
                    localStorage.setItem('guidancePrices', JSON.stringify(guidancePrices));
                    
                    priceInput.disabled = true;
                    e.currentTarget.classList.add('hidden');
                    container.querySelector('.edit-guidance').classList.remove('hidden');
                    container.querySelector('.save-time').textContent = saveTime;
                });
            });

            document.querySelectorAll('.edit-guidance').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const container = e.currentTarget.closest('[id^="guidance-"]');
                    const priceInput = container.querySelector('.guidance-price');
                    priceInput.disabled = false;
                    priceInput.focus();
                    e.currentTarget.classList.add('hidden');
                    container.querySelector('.save-guidance').classList.remove('hidden');
                });
            });

            // 初始化
            renderHistoryList();
        });
    </script>
</body>
</html>