<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ²¹å“æˆæœ¬è®¡ç®—å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #1976D2;
            --accent-color: #FF9800;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent;
        }

        /* é¡µé¢å®¹å™¨ä¸åˆ‡æ¢ */
        .page {
            display: none;
            padding: 16px;
            padding-bottom: 50px;
            animation: fadeIn 0.3s;
        }
        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é€šç”¨ç»„ä»¶ */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 16px;
        }

        h2, h3 { margin-top: 0; }
        
        input[type="number"] {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            outline: none;
        }
        input[type="number"]:focus {
            border-color: var(--primary-color);
        }

        .btn {
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: opacity 0.2s;
            font-weight: bold;
        }
        .btn:active { opacity: 0.8; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); }
        .btn-danger { background: #ff4444; color: white; padding: 6px 12px; font-size: 14px; }

        /* ä¸»é¡µå¸ƒå±€ */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }
        
        .oil-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            font-size: 15px;
            color: #555;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .oil-btn.active {
            background: #e3f2fd;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .result-box {
            text-align: center;
            padding: 20px 0;
        }
        .result-value {
            font-size: 36px;
            font-weight: bold;
            color: var(--primary-color);
        }
        .result-label {
            color: #666;
            font-size: 14px;
        }

        /* å†å²è®°å½• */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .history-info { flex: 1; }
        .history-date { font-size: 12px; color: #888; margin-bottom: 4px; }
        .history-details { font-size: 14px; font-weight: 500; }
        .history-price { color: var(--accent-color); font-weight: bold; margin-left: 10px; }

        /* å¯¼èˆªåŒº */
        .nav-area {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .nav-btn {
            flex: 1;
            margin: 0 5px;
            background: #fff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        /* æŒ‡å¯¼ä»·è®¾ç½® */
        .guide-item {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .guide-label { width: 80px; font-size: 14px; font-weight: bold; }
        .guide-input-group { flex: 1; display: flex; gap: 5px; }
        .guide-time { font-size: 12px; color: #999; text-align: right; margin-top: 2px; }

        /* è¿”å›æŒ‰é’® */
        .back-bar {
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .back-btn {
            background: none;
            border: none;
            font-size: 16px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        .back-btn::before {
            content: "â†";
            font-size: 20px;
            margin-right: 5px;
        }

        /* å¼¹çª—æç¤º */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 25px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 16px;
        }
        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="page-home" class="page active">
        <div class="card">
            <h3>è®¡ç®—æˆæœ¬</h3>
            <input type="number" id="factory-price" placeholder="è¯·è¾“å…¥å‡ºå‚ä»· (å…ƒ)" inputmode="decimal">
            
            <div class="grid-2">
                <button class="oil-btn" onclick="calculate('gas', 'å«ç¨æ±½æ²¹')">å«ç¨æ±½æ²¹</button>
                <button class="oil-btn" onclick="calculate('gas', 'ä¸å«ç¨æ±½æ²¹')">ä¸å«ç¨æ±½æ²¹</button>
                <button class="oil-btn" onclick="calculate('diesel', 'å«ç¨æŸ´æ²¹')">å«ç¨æŸ´æ²¹</button>
                <button class="oil-btn" onclick="calculate('diesel', 'ä¸å«ç¨æŸ´æ²¹')">ä¸å«ç¨æŸ´æ²¹</button>
            </div>

            <div class="result-box">
                <div class="result-label">åˆ°ç«™æˆæœ¬ä»·</div>
                <div class="result-value" id="result-display">0.00</div>
            </div>
        </div>

        <div class="nav-area">
            <button class="btn nav-btn" onclick="switchPage('page-chart'); renderChart();">ğŸ“ˆ ä»·æ ¼è¶‹åŠ¿</button>
            <button class="btn nav-btn" onclick="switchPage('page-guide'); loadGuidePrices();">âš™ï¸ å½“å‰æŒ‡å¯¼ä»·</button>
        </div>

        <div class="card">
            <h3>å†å²è®°å½•</h3>
            <div id="history-list">
                <div style="text-align:center; color:#999; padding:20px;">æš‚æ— è®°å½•</div>
            </div>
        </div>
    </div>

    <div id="page-chart" class="page">
        <div class="back-bar">
            <button class="back-btn" onclick="switchPage('page-home')">è¿”å›ä¸»ç•Œé¢</button>
        </div>
        <div class="card">
            <h3>ä»·æ ¼è¶‹åŠ¿ (è¿‘30å¤©)</h3>
            <div style="position: relative; height: 300px; width:100%">
                <canvas id="trendChart"></canvas>
            </div>
            <div style="margin-top:15px; font-size:12px; color:#666; text-align:center;">
                * ç¼©æ”¾å›¾è¡¨æŸ¥çœ‹è¯¦ç»†æ•°æ®
            </div>
        </div>
    </div>

    <div id="page-guide" class="page">
        <div class="back-bar">
            <button class="back-btn" onclick="switchPage('page-home')">è¿”å›ä¸»ç•Œé¢</button>
        </div>
        <div class="card">
            <h3>å½“å‰æŒ‡å¯¼ä»·è®¾ç½®</h3>
            <div id="guide-container">
                </div>
        </div>
    </div>

<script>
    // --- PWA é…ç½® (Manifest & Service Worker) ---
    const manifest = {
        "name": "æ²¹å“æˆæœ¬è®¡ç®—å™¨",
        "short_name": "æ²¹å“è®¡ç®—",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#f5f5f5",
        "theme_color": "#1976D2",
        "icons": [
            {
                "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%231976D2'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='300' fill='white'%3Eâ›½%3C/text%3E%3C/svg%3E",
                "sizes": "192x192",
                "type": "image/svg+xml"
            }
        ]
    };
    
    // æ³¨å…¥ Manifest
    const link = document.createElement('link');
    link.rel = 'manifest';
    const stringManifest = JSON.stringify(manifest);
    const blob = new Blob([stringManifest], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(blob);
    link.href = manifestURL;
    document.head.appendChild(link);

    // æ³¨å†Œ Service Worker (ç”¨äºç®€å•çš„ç¦»çº¿ç¼“å­˜ç­–ç•¥)
    if ('serviceWorker' in navigator) {
        const swCode = `
            self.addEventListener('install', (e) => {
                e.waitUntil(self.skipWaiting());
            });
            self.addEventListener('fetch', (e) => {
                e.respondWith(fetch(e.request).catch(() => {
                    return new Response('Offline - Network Error');
                }));
            });
        `;
        const swBlob = new Blob([swCode], {type: 'application/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl)
            .then(() => console.log('SW Registered'))
            .catch(err => console.error('SW Error', err));
    }

    // --- åº”ç”¨é€»è¾‘ ---

    // çŠ¶æ€ç®¡ç†
    const STORAGE_KEY_HISTORY = 'oil_calc_history';
    const STORAGE_KEY_GUIDE = 'oil_calc_guide';
    let historyData = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY) || '[]');
    let guideData = JSON.parse(localStorage.getItem(STORAGE_KEY_GUIDE) || JSON.stringify({
        '0å·æŸ´æ²¹': { price: '', time: 'æœªè®¾ç½®' },
        '92å·æ±½æ²¹': { price: '', time: 'æœªè®¾ç½®' },
        '95å·æ±½æ²¹': { price: '', time: 'æœªè®¾ç½®' },
        'å¸ƒä¼¦ç‰¹åŸæ²¹': { price: '', time: 'æœªè®¾ç½®' }
    }));

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        renderHistory();
    });

    // é¡µé¢åˆ‡æ¢
    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    }

    // Toast æç¤º
    function showToast(message) {
        const x = document.getElementById("toast");
        x.className = "show";
        x.innerText = message;
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    // --- ä¸»é¡µåŠŸèƒ½ ---

    function calculate(type, typeName) {
        const input = document.getElementById('factory-price');
        const price = parseFloat(input.value);

        if (isNaN(price)) {
            showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„å‡ºå‚ä»·æ ¼");
            input.focus();
            return;
        }

        let result = 0;
        // è®¡ç®—å…¬å¼
        // æ±½æ²¹ï¼š(å‡ºå‚ä»·+210)Ã·1350
        // æŸ´æ²¹ï¼š(å‡ºå‚ä»·+210)Ã·1200
        if (type === 'gas') {
            result = (price + 210) / 1350;
        } else {
            result = (price + 210) / 1200;
        }

        // ä¿ç•™4ä½å°æ•°å±•ç¤ºè¯¦ç»†ï¼Œæˆ–è€…2ä½çœ‹éœ€æ±‚ï¼Œè¿™é‡Œä¿ç•™3ä½æ¯”è¾ƒåˆç†
        const finalPrice = result.toFixed(3);
        
        // æ›´æ–°UI
        document.getElementById('result-display').innerText = finalPrice;
        
        // æŒ‰é’®é«˜äº®åé¦ˆ
        document.querySelectorAll('.oil-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        // ä¿å­˜å†å²
        saveHistory(typeName, price, finalPrice);
    }

    function saveHistory(type, factoryPrice, costPrice) {
        const now = new Date();
        const record = {
            id: Date.now(),
            timeStr: now.toLocaleString('zh-CN', { hour12: false }),
            timestamp: now.getTime(),
            type: type,
            factory: factoryPrice,
            cost: costPrice
        };

        historyData.unshift(record); // åŠ åˆ°å¼€å¤´
        
        // é™åˆ¶100æ¡
        if (historyData.length > 100) {
            historyData.pop();
        }

        localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(historyData));
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';

        if (historyData.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æš‚æ— è®¡ç®—è®°å½•</div>';
            return;
        }

        historyData.forEach(item => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div class="history-info">
                    <div class="history-date">${item.timeStr}</div>
                    <div class="history-details">
                        ${item.type} (å‡ºå‚: ${item.factory})
                    </div>
                </div>
                <div class="history-price">Â¥${item.cost}</div>
                <button class="btn btn-danger" style="margin-left:10px;" onclick="deleteHistory(${item.id})">åˆ é™¤</button>
            `;
            list.appendChild(div);
        });
    }

    function deleteHistory(id) {
        if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            historyData = historyData.filter(item => item.id !== id);
            localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(historyData));
            renderHistory();
        }
    }

    // --- å›¾è¡¨åŠŸèƒ½ ---
    let chartInstance = null;

    function renderChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        // æ•°æ®å¤„ç†ï¼šæŒ‰å¤©èšåˆï¼Œå–å½“å¤©çš„å¹³å‡ä»·æˆ–æœ€åä¸€æ¬¡ä»·æ ¼ï¼ˆè¿™é‡Œå–å½“å¤©æœ€åä¸€æ¬¡è®¡ç®—çš„ä»·æ ¼ï¼‰
        // ä¸ºäº†å›¾è¡¨å¥½çœ‹ï¼Œæˆ‘ä»¬éœ€è¦æŒ‰ç±»å‹åˆ†ç±»æ•°æ®
        const types = ['å«ç¨æ±½æ²¹', 'ä¸å«ç¨æ±½æ²¹', 'å«ç¨æŸ´æ²¹', 'ä¸å«ç¨æŸ´æ²¹'];
        const colors = ['#F44336', '#FF9800', '#2196F3', '#4CAF50'];
        
        const datasets = types.map((type, index) => {
            // ç­›é€‰è¯¥ç±»å‹æ•°æ®ï¼Œå¹¶æŒ‰æ—¶é—´æ­£åºæ’åˆ—
            const filtered = historyData
                .filter(d => d.type === type)
                .sort((a, b) => a.timestamp - b.timestamp);
            
            // æå–æ•°æ®ç‚¹ {x: date, y: cost}
            const dataPoints = filtered.map(d => ({
                x: new Date(d.timestamp).toLocaleDateString(), // ç®€åŒ–ä¸ºæ—¥æœŸ
                y: d.cost
            }));

            return {
                label: type,
                data: dataPoints,
                borderColor: colors[index],
                backgroundColor: colors[index],
                tension: 0.1,
                fill: false
            };
        });

        // é”€æ¯æ—§å›¾è¡¨
        if (chartInstance) {
            chartInstance.destroy();
        }

        // ç®€å•å¤„ç†ï¼šChart.js éœ€è¦ labelsï¼Œæˆ–è€… x/y ç»“æ„ã€‚è¿™é‡Œç”¨ç®€å•çš„ labels é›†åˆ
        // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬æ”¶é›†æ‰€æœ‰å‡ºç°çš„æ—¥æœŸä½œä¸º labels
        const allDates = [...new Set(historyData.map(d => new Date(d.timestamp).toLocaleDateString()))].sort();

        // æ˜ å°„æ•°æ®åˆ° labels (Chart.js ç®€å•æ¨¡å¼)
        const finalDatasets = datasets.map(ds => {
            const dataMap = {};
            ds.data.forEach(p => dataMap[p.x] = p.y);
            // å¦‚æœæŸå¤©æ²¡æœ‰æ•°æ®ï¼ŒChartJSä¼šè‡ªåŠ¨æ–­å¼€æˆ–è¡¥å€¼ï¼Œè¿™é‡Œç•™ç©º
            const alignedData = allDates.map(date => dataMap[date] || null); 
            return { ...ds, data: alignedData };
        });

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: allDates,
                datasets: finalDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'æˆæœ¬ä»·' }
                    }
                }
            }
        });
    }

    // --- æŒ‡å¯¼ä»·åŠŸèƒ½ ---

    function loadGuidePrices() {
        const container = document.getElementById('guide-container');
        container.innerHTML = '';
        const items = ['0å·æŸ´æ²¹', '92å·æ±½æ²¹', '95å·æ±½æ²¹', 'å¸ƒä¼¦ç‰¹åŸæ²¹'];

        items.forEach(key => {
            const data = guideData[key] || { price: '', time: 'æœªè®¾ç½®' };
            
            const div = document.createElement('div');
            div.className = 'guide-item';
            div.innerHTML = `
                <div class="guide-label">${key}</div>
                <div style="flex:1">
                    <div class="guide-input-group">
                        <input type="number" id="input-${key}" value="${data.price}" placeholder="è¾“å…¥ä»·æ ¼">
                        <button class="btn btn-primary" style="padding: 8px 12px; font-size:14px;" onclick="saveGuide('${key}')">ä¿å­˜</button>
                    </div>
                    <div class="guide-time" id="time-${key}">ä¸Šæ¬¡æ›´æ–°: ${data.time}</div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function saveGuide(key) {
        const input = document.getElementById(`input-${key}`);
        const val = input.value;
        if (!val) {
            showToast("ä»·æ ¼ä¸èƒ½ä¸ºç©º");
            return;
        }

        const nowStr = new Date().toLocaleString('zh-CN', { hour12: false });
        
        // æ›´æ–°æ•°æ®
        guideData[key] = {
            price: val,
            time: nowStr
        };

        // æŒä¹…åŒ–
        localStorage.setItem(STORAGE_KEY_GUIDE, JSON.stringify(guideData));
        
        // æ›´æ–°UIæ—¶é—´æ˜¾ç¤º
        document.getElementById(`time-${key}`).innerText = `ä¸Šæ¬¡æ›´æ–°: ${nowStr}`;
        
        // è¾“å…¥æ¡†é€»è¾‘ï¼šç‚¹å‡»ä¿å­˜åï¼Œå…¶å®è¿˜æ˜¯å¯ä»¥ç¼–è¾‘çš„ï¼ˆå³â€œä¿®æ”¹â€æŒ‰é’®é€»è¾‘åˆå¹¶åœ¨è¾“å…¥æ¡†æœ¬èº«ï¼‰ï¼Œ
        // ä¸ºäº†ä½“éªŒï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¿å­˜åé—ªçƒä¸€ä¸‹æˆ–è€…Toast
        showToast(`${key} å·²ä¿å­˜`);
    }

</script>
</body>
</html>
